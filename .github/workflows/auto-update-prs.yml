name: Auto Update Pull Requests

on:
  push:
    branches:
      - master
      - main
  schedule:
    # Run daily at 2 AM UTC to catch any missed updates
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  update-prs:
    name: Update Outdated Pull Requests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch all branches
        run: |
          git fetch origin

      - name: Get base branch name
        id: base-branch
        run: |
          # Check remote branches first (more reliable)
          if git show-ref --verify --quiet refs/remotes/origin/master; then
            echo "branch=master" >> $GITHUB_OUTPUT
          elif git show-ref --verify --quiet refs/remotes/origin/main; then
            echo "branch=main" >> $GITHUB_OUTPUT
          # Fallback to local branches
          elif git show-ref --verify --quiet refs/heads/master; then
            echo "branch=master" >> $GITHUB_OUTPUT
          elif git show-ref --verify --quiet refs/heads/main; then
            echo "branch=main" >> $GITHUB_OUTPUT
          else
            echo "ERROR: Neither master nor main branch found"
            exit 1
          fi

      - name: Get list of open pull requests
        id: pr-list
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const baseBranch = '${{ steps.base-branch.outputs.branch }}';
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              base: baseBranch,
              sort: 'updated',
              direction: 'desc'
            });
            
            const prData = prs.map(pr => ({
              number: pr.number,
              head: pr.head.ref,
              sha: pr.head.sha,
              user: pr.user.login,
              repo: pr.head.repo.full_name
            }));
            
            core.setOutput('prs', JSON.stringify(prData));
            return prData;

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Update each pull request
        env:
          BASE_BRANCH: ${{ steps.base-branch.outputs.branch }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.repository }}
        run: |
          PR_LIST='${{ steps.pr-list.outputs.prs }}'
          
          # Check if PR list is empty
          if [ -z "$PR_LIST" ] || [ "$PR_LIST" = "null" ] || [ "$PR_LIST" = "[]" ]; then
            echo "No open pull requests found"
            exit 0
          fi
          
          # Validate JSON before parsing
          if ! echo "$PR_LIST" | jq empty 2>/dev/null; then
            echo "ERROR: Invalid JSON from PR list"
            echo "PR_LIST: $PR_LIST"
            exit 1
          fi
          
          # Parse PR list (it's a JSON array)
          echo "$PR_LIST" | jq -r '.[] | "\(.number)|\(.head)|\(.sha)|\(.user)|\(.repo)"' | while IFS='|' read -r pr_number pr_head pr_sha pr_user pr_repo; do
            # Skip empty lines
            [ -z "$pr_number" ] && continue
            
            echo "Processing PR #$pr_number ($pr_head by @$pr_user)"
            
            # Skip if PR is from a fork (we can't push to forks)
            if [ "$pr_repo" = "$REPO_NAME" ]; then
              echo "  ✓ PR is from same repository, can update"
            else
              echo "  ⚠ PR is from fork ($pr_repo), skipping (cannot push to forks)"
              continue
            fi
            
            # Fetch the PR branch from remote
            git fetch origin "$pr_head" || {
              echo "  ✗ Failed to fetch branch $pr_head from origin"
              continue
            }
            
            # Checkout the PR branch (create local tracking branch if needed)
            # First try to checkout existing local branch, then create new one from remote
            if git show-ref --verify --quiet refs/heads/"$pr_head"; then
              git checkout "$pr_head" || {
                echo "  ✗ Failed to checkout existing local branch $pr_head"
                continue
              }
            else
              git checkout -b "$pr_head" "origin/$pr_head" || {
                echo "  ✗ Failed to create and checkout branch $pr_head from origin/$pr_head"
                continue
              }
            fi
            
            # Ensure we're on the correct branch
            CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
            if [ "$CURRENT_BRANCH" != "$pr_head" ]; then
              echo "  ✗ Not on expected branch (on $CURRENT_BRANCH, expected $pr_head)"
              continue
            fi
            
            # Check if branch is behind base branch
            BASE_SHA=$(git rev-parse "origin/$BASE_BRANCH" 2>/dev/null)
            HEAD_SHA=$(git rev-parse HEAD 2>/dev/null)
            
            if [ -z "$BASE_SHA" ] || [ -z "$HEAD_SHA" ]; then
              echo "  ✗ Failed to get commit SHAs"
              continue
            fi
            
            MERGE_BASE=$(git merge-base "origin/$BASE_BRANCH" HEAD 2>/dev/null)
            
            if [ -z "$MERGE_BASE" ]; then
              echo "  ✗ Failed to find merge base"
              continue
            fi
            
            # If merge-base equals HEAD, branch is up to date
            # If merge-base equals BASE, branch is completely behind
            # If merge-base is different from both, branch has diverged
            if [ "$MERGE_BASE" = "$HEAD_SHA" ]; then
              echo "  ✓ Branch is up to date with $BASE_BRANCH"
              git checkout "$BASE_BRANCH" 2>/dev/null || git checkout "origin/$BASE_BRANCH" || true
              continue
            fi
            
            echo "  ↻ Branch is behind $BASE_BRANCH, updating..."
            
            # Merge the latest changes from base branch
            git merge "origin/$BASE_BRANCH" --no-edit || {
              echo "  ✗ Merge conflict detected, skipping PR #$pr_number"
              git merge --abort || true
              git checkout "$BASE_BRANCH" 2>/dev/null || git checkout "origin/$BASE_BRANCH" || true
              continue
            }
            
            # Push the updated branch
            # Check if there are actual changes to push
            if git diff --quiet HEAD "origin/$pr_head" 2>/dev/null; then
              echo "  ✓ No changes to push (branch already up to date)"
            else
              echo "  ↑ Pushing updated branch..."
              # Force push is not needed, regular push should work
              if git push origin "$pr_head"; then
                echo "  ✅ Successfully updated PR #$pr_number"
              else
                echo "  ✗ Failed to push to $pr_head"
                git checkout "$BASE_BRANCH" 2>/dev/null || git checkout "origin/$BASE_BRANCH" || true
                continue
              fi
            fi
            
            # Return to base branch for next iteration (or detach HEAD if branch doesn't exist locally)
            git checkout "$BASE_BRANCH" 2>/dev/null || git checkout "origin/$BASE_BRANCH" || true
          done
          
          # Clean up: return to a safe state
          git checkout "origin/$BASE_BRANCH" 2>/dev/null || true

      - name: Summary
        run: |
          echo "## Auto Update PRs Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Completed updating outdated pull requests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This workflow:" >> $GITHUB_STEP_SUMMARY
          echo "- Checks all open PRs targeting \`${{ steps.base-branch.outputs.branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Merges latest changes from base branch" >> $GITHUB_STEP_SUMMARY
          echo "- Skips PRs from forks (cannot push to forks)" >> $GITHUB_STEP_SUMMARY
          echo "- Skips PRs with merge conflicts (requires manual resolution)" >> $GITHUB_STEP_SUMMARY

